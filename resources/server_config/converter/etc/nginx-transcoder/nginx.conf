worker_processes 4;
#worker_priority -1;
worker_rlimit_nofile 8192;
#worker_cpu_affinity 0001 0010 0100 1000;

user www-data;
pid /var/run/nginx.pid;
error_log /var/log/nginx/error.log debug; # +" debug";

events {
  multi_accept on;
  worker_connections 1024; # worker_processes * worker_connections = maxclients
}

## HTTP configuration

http {
  include mime.types;
  include /etc/nginx/conf.d/*.http.conf;

  map_hash_bucket_size 128;
  default_type application/octet-stream;

  sendfile on;
  tcp_nopush on;
  keepalive_timeout 65;
  gzip off;

  ## Logs
  # Normal access log
  access_log /var/log/nginx/access.log main;
  # Cache status logs
  access_log /var/log/nginx/cache.log cache;

  # Include site configuration files
  include /etc/nginx/sites-enabled/*;

} # http

## RTMP configuration

# Multi worker streaming
rtmp_auto_push on;
rtmp_auto_push_reconnect 1s;
rtmp_socket_dir /tmp;

rtmp {

  server {

    # Server IP address
    listen 10.10.3.174:1935;
    listen localhost:1935;

    # Maximum chunk size for stream multiplexing. Default is 4096. The bigger this value the lower CPU overhead.
    chunk_size 4096;

    ping 30s;
    ping_timeout 10s;

    notify_method get;

    # Max connections to RTMP engine
    max_connections 200;

    wait_key on;
#    wait_video on;

    # Wowza PROD
    application vsqlive {
      live on;
      pull rtmp://vsq-stream.bonafarm.hu:1935/vsqlive;
      on_play http://vsq.bonafarm.hu/hu/live/checkstreamaccess;
    }

    # Videosquare: live transcoding + recording
    application vsqlivetrans {
      live on;
      record all;
#      allow publish 172.19.0.0/16;
      allow publish all;
#      deny publish all;
      allow play all;

      # Recorder
      recorder video {
          record all;
          record_path /srv/vsq_temp/videosquare.eu/recorder;
          record_suffix _%Y-%m-%d_%H%M%S.flv;
          record_unique on;
          record_lock on;
#          record_interval 600s;
      }

      # ffmpeg transcoding
      exec /home/conv/ffmpeg/ffmpeg-customVSQ-20150116-git-gc4f1abe/ffmpeg -y -i rtmp://localhost:1935/${app}/${name} -threads 0
           -c:v libx264 -profile:v baseline -b:v 200K  -s 320x180 -f flv -c:a aac -ac 1 -strict -2 -b:a 64k rtmp://vsq-stream.bonafarm.hu:1935/vsqlive?doPublish=k3r3v3t3n/${name}_180p
           -c:v libx264 -profile:v baseline -b:v 350K  -s 424x240 -f flv -c:a aac -ac 1 -strict -2 -b:a 64k rtmp://vsq-stream.bonafarm.hu:1935/vsqlive?doPublish=k3r3v3t3n/${name}_240p
           -c:v libx264 -profile:v baseline -b:v 700K  -s 640x360 -f flv -c:a aac -ac 1 -strict -2 -b:a 64k rtmp://vsq-stream.bonafarm.hu:1935/vsqlive?doPublish=k3r3v3t3n/${name}_360p
           -c:v libx264 -profile:v baseline -b:v 1200K -s 854x480 -f flv -c:a aac -ac 2 -strict -2 -b:a 96k rtmp://vsq-stream.bonafarm.hu:1935/vsqlive?doPublish=k3r3v3t3n/${name}_480p;
#           -c:v libx264 -profile:v baseline -b:v 2000K -s 1280x720 -f flv -c:a aac -ac 2 -strict -2 -b:a 96k rtmp://vsq-stream.bonafarm.hu:1935/vsqlive?doPublish=k3r3v3t3n/${name}_720p;

    } # vsqlivetrans

  } # server

} # rtmp
