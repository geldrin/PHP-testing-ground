# Videosquare portal server firewall filtering configuration file ver. 20140418

# Default devices
@def $DEV_LOCAL = lo;

## Videosquare nodes

# Vsq streaming servers
@def $VSQ_NODES_STREAM = (
    # Stream 1: Main
    172.18.1.31         # MAIN: stream.vsq.streamnet.hu
);

# Vsq converter
@def $VSQ_NODES_CONV = (
    172.18.1.33         # Converter: conv-1.vsq.streamnet.hu
);

# Vsq portal HTTP servers
@def $VSQ_NODES_PORTAL = (
    172.18.1.30         # Portal: vsq.streamnet.hu
    172.18.1.32         # Static: static.vsq.streamnet.hu.
);

# Vsq: all nodes
@def $VSQ_NODES = (
    # Portal server
    $VSQ_NODES_PORTAL
    # Streaming servers
    $VSQ_NODES_STREAM
    # Converter servers
    $VSQ_NODES_CONV
);

# Streaming server service ports
@def $WOWZA_PORTS = (
    1935	# RTMP
    554		# RTSP
    http	# RTMPT, HLS, HDS
    https	# HLS, HDS
);

# IPv4/IPv6 policies
domain (ip ip6) {
    table filter {

	## Basic chain policies
	
	#  Allow all output, deny all input/forward by default
	chain (INPUT FORWARD) policy DROP;
	chain OUTPUT policy ACCEPT;
	
	#  Allow all traffic on loopback interface
	chain INPUT  interface $DEV_LOCAL ACCEPT;
	chain OUTPUT outerface $DEV_LOCAL ACCEPT;

	#  Drop invalid state connections
	chain (INPUT OUTPUT FORWARD) mod state state INVALID DROP;
	chain (INPUT OUTPUT FORWARD) mod state state (ESTABLISHED RELATED) ACCEPT;

	chain INPUT {

	    # Accept all ICMP (rate limitation by kernel)
	    proto icmp ACCEPT;

	    # Allow SSH connections
	    proto tcp dport ssh ACCEPT;

	}

    } # FILTER

} # EoF IP/IP6 general filtering

# IPv4 specific filtering
domain ip {
    table filter {

	# Local packets
	chain INPUT {

	    # Allow Munin monitoring
	    saddr $VSQ_NODES proto tcp dport 4949 ACCEPT;

	    # Allow Wowza Engine Manager access
	    proto tcp dport 8088 ACCEPT;

	    # Allow HTTP for VSQ-Edge service
	    proto tcp dport (http https) ACCEPT;

	    # Allow Wowza traffic
	    proto tcp dport $WOWZA_PORTS ACCEPT;

#	    mod limit limit 3/minute limit-burst 10
#		LOG log-level warning log-prefix 'iptables: ipv4_input_drop ';

	    REJECT;
	}

    }
} # EoF IPv4 related filtering

# IPv6 specific filtering starts here
domain ip6 {
    table filter {

	chain INPUT {

#		mod limit limit 3/minute limit-burst 10
#		LOG log-level warning log-prefix 'iptables: ipv6_input_drop ';

	    REJECT;
	}

    } # FILTER

} # EoF IPv6 related filtering