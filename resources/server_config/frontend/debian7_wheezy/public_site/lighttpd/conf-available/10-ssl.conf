# Videosquare Lighttpd SSL configuration

# HSTS: Redirect HTTP permanently to HTTPS
$HTTP["scheme"] == "http" {
  $HTTP["host"] =~ ".*" {
    url.redirect-code = 301
    url.redirect = (".*" => "https://%0$0")
  }
}

$SERVER["socket"] == "91.120.59.234:443" {
  ssl.engine  = "enable"
  ssl.pemfile = "/etc/apache2/certs/videosquare.eu.pem"
  ssl.ca-file = "/etc/apache2/certs/startssl-certs-class2.crt"
  # openssl dhparam -out dhparams.pem 2048
  ssl.dh-file = "/etc/apache2/certs/dhparams.pem"

  # Intermediate compatibility: Firefox 1, Chrome 1, IE 7, Opera 5 and Safari 1 (TLSv1, TLSv1.1, TLSv1.2)
  ssl.cipher-list = "ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA"

  ssl.honor-cipher-order = "enable"
  ssl.use-sslv2 = "disable"
  ssl.use-sslv3 = "disable"
  ssl.disable-client-renegotiation = "enable"
  ssl.ec-curve = "secp384r1"
  # Against CRIME attack
#  ssl.use-compression = "disable"

  ## Site specific configurations

  # Production main site
  $HTTP["host"] == "static.videosquare.eu" {

    # Add CORS response header
    setenv.add-response-header += (
      "Access-Control-Allow-Origin" => "https://videosquare.eu"
    )

    # Add HSTS response header
    setenv.add-response-header += var.strict-transport-security
  }

  # Production subdomain site: static*.videosquare.eu
  $HTTP["host"] =~ "^static.+\.videosquare\.eu$" {

    # Add CORS response header
    setenv.add-response-header += (
      "Access-Control-Allow-Origin" => "https://*.videosquare.eu"
    )

    # Add HSTS response header
    setenv.add-response-header += var.strict-transport-security
  }

  # DEV main static: vsq-staticdev.videosquare.eu
  $HTTP["host"] == "vsq-staticdev.videosquare.eu" {

    # Add CORS response header
    setenv.add-response-header += (
      "Access-Control-Allow-Origin" => "https://dev.videosquare.eu",
    )

    # Add HSTS response header
    setenv.add-response-header += var.strict-transport-security
  }

  # DEV subdomain static: vsq-staticdev*.videosquare.eu
  $HTTP["host"] =~ "^vsq-staticdev(.+)\.videosquare\.eu$" {

    # Add CORS response header
    setenv.add-response-header += (
      "Access-Control-Allow-Origin" => "https://*.dev.videosquare.eu",
    )

    # Add HSTS response header
    setenv.add-response-header += var.strict-transport-security
  }

}