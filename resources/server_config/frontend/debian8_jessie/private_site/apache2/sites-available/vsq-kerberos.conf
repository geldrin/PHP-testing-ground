<VirtualHost vsq.bonafarm.hu:80>
    DocumentRoot /var/www/kerberos
    ServerName vsq.bonafarm.hu
    ServerAdmin support@videosqr.com

    RewriteEngine On
    RewriteRule ^/[a-z]{2,4}/contents - [E=no_auth_required:1]
    RewriteRule ^/[a-z]{2,4}/combine - [E=no_auth_required:1]
    RewriteRule ^/([a-z]{2,4}/)?(recordings|live)/(secure)?checkstreamaccess - [E=no_auth_required:1]
    RewriteRule ^/[a-z]{2,4}/api - [E=no_auth_required:1]

#    ProxyPassMatch ^/(.*\.php(/.*)?)$ fcgi://127.0.0.1:9000/var/www/kerberos/$1
    <FilesMatch \.php$>
        SetHandler "proxy:fcgi://127.0.0.1:9000"
    </FilesMatch>

    <Directory />
        Options FollowSymLinks
        AllowOverride None
    </Directory>

    <Directory /var/www/kerberos>

        Options Indexes FollowSymLinks
        AllowOverride All

        # Authentication
        <RequireAny>

            # Allow local request (e.g. combine)
            <RequireAny>
                Require ip 127.0.0.1
                # Front-end IP addresses
                Require ip 10.10.3.171
                Require ip 10.10.3.172
                Require ip 10.10.3.173
                # vsq-conv.bonafarm.hu
                Require ip 10.10.3.174
                # vsq-edge-test.bonafarm.hu
                Require ip 172.16.127.247
            </RequireAny>

            # Allow specific URLs with no authentication
            <RequireAll>
                Require env no_auth_required
                Require all granted
            </RequireAll>

            # Kerberos SSO authentication
            <RequireAll>
                AuthType Kerberos
                AuthName "Bonafarm SSO Login"
                KrbAuthRealm BONAFARM.GROUP
                Krb5Keytab /etc/apache2/certs/vsqH4.keytab
#                KrbServiceName HTTP/vsq.bonafarm.hu
                KrbServiceName Any
                KrbMethodNegotiate On
                KrbSaveCredentials Off
                KrbMethodK5Passwd On
                KrbVerifyKDC On
                KrbAuthoritative Off
                Require valid-user
            </RequireAll>

        </RequireAny>

    </Directory>

    LogLevel warn
    ErrorLog ${APACHE_LOG_DIR}/vsq.bonafarm.hu-kerb-error.log
    CustomLog ${APACHE_LOG_DIR}/vsq.bonafarm.hu-kerb-access.log combined

</VirtualHost>

#<IfModule mod_ssl.c>
...
#</IfModule>
